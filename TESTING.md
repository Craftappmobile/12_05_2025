# Рекомендації щодо тестування Calculate and Knit

## Структура тестів

Тести розділені на наступні категорії:

1. **Модульні тести** - тестування окремих компонентів системи
   - `__tests__/modules/migrations/` - тести модуля міграцій
   - `__tests__/modules/sync/` - тести модуля синхронізації

2. **Інтеграційні тести** - тестування взаємодії між компонентами
   - `__tests__/integration/` - інтеграційні сценарії

3. **Моки** - заглушки для зовнішніх сервісів
   - `__tests__/mocks/` - моки для WatermelonDB, Supabase та інших сервісів

## Запуск тестів

Використовуйте наступні команди для запуску тестів:

```bash
# Запуск всіх тестів
npm test

# Запуск з відстеженням змін
npm run test:watch

# Запуск з покриттям коду
npm run test:coverage

# Запуск тільки модульних тестів
npm run test:unit

# Запуск тільки інтеграційних тестів
npm run test:integration
```

## Критичні сценарії для тестування

### Модуль міграцій

1. **Міграція вперед** - перевірка успішної міграції до новішої версії
   - Усі міграції виконуються в правильному порядку
   - Схема даних оновлюється до цільової версії
   - Нові таблиці створюються коректно

2. **Міграція назад** - перевірка успішного відкату до старішої версії
   - Міграції назад виконуються в зворотному порядку
   - Схема даних повертається до цільової версії
   - Видаляються таблиці, які не потрібні в старій версії

3. **Обробка помилок** - перевірка обробки різноманітних помилок при міграції
   - Обробка помилок в транзакції
   - Відновлення після збою

### Модуль синхронізації

1. **Відправка локальних змін** - перевірка успішної передачі локальних змін на сервер
   - Нові записи додаються на сервер
   - Оновлені записи синхронізуються
   - Видалені записи видаляються і на сервері

2. **Отримання серверних змін** - перевірка успішного отримання змін з сервера
   - Нові серверні записи додаються локально
   - Оновлені серверні записи синхронізуються
   - Видалені на сервері записи видаляються і локально

3. **Вирішення конфліктів** - перевірка різних стратегій вирішення конфліктів
   - Стратегія SERVER_WINS
   - Стратегія CLIENT_WINS
   - Стратегія NEWEST_WINS
   - Стратегія MANUAL (з взаємодією користувача)

4. **Синхронізація без мережі** - перевірка поведінки при відсутності доступу до мережі
   - Правильна обробка помилок мережі
   - Збереження локальних змін для майбутньої синхронізації
   - Відновлення синхронізації після повернення мережі

5. **Проблеми автентифікації** - перевірка поведінки при проблемах з автентифікацією
   - Обробка закінчення терміну дії сесії
   - Спроби синхронізації без автентифікації

### Інтеграційні сценарії

1. **Міграція та синхронізація** - перевірка взаємодії між міграцією та синхронізацією
   - Синхронізація після міграції вперед
   - Синхронізація після міграції назад

2. **Офлайн-робота** - перевірка повноцінної роботи додатку в офлайн-режимі
   - Збереження змін локально
   - Синхронізація при відновленні мережі

## Тестування серверної частини в Supabase

### Тестування міграцій SQL

1. Створіть тестову базу даних в Supabase для тестування
2. Застосуйте міграційні SQL-скрипти до тестової бази даних
3. Перевірте структуру бази даних після міграції
4. Перевірте правильність зворотних міграцій

### Тестування політик Row-Level Security (RLS)

1. Створіть кілька тестових користувачів з різними ролями
2. Перевірте, що користувачі мають доступ тільки до своїх даних
3. Перевірте політики для кожної операції (SELECT, INSERT, UPDATE, DELETE)

## Автоматизація тестування

### Налаштування Husky для pre-commit хуків

```bash
# Встановлення Husky
npm install husky --save-dev

# Ініціалізація Husky
npx husky install

# Додавання pre-commit хука для запуску тестів перед комітом
npx husky add .husky/pre-commit "npm run test:unit"
```

### Налаштування CI/CD в GitHub Actions

Створіть файл `.github/workflows/tests.yml`:

```yaml
name: Tests

on:
  push:
    branches: [ main, development ]
  pull_request:
    branches: [ main, development ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    - name: Use Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
      
    - name: Run tests
      run: npm test
      
    - name: Generate coverage report
      run: npm run test:coverage
      
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
```

## Контрольний список якості

- [x] Усі модульні тести проходять успішно
- [x] Усі інтеграційні тести проходять успішно
- [ ] Покриття коду тестами > 70%
- [ ] Перевірка типів TypeScript проходить без помилок
- [ ] ESLint не показує критичних помилок
- [x] Додаток працює в офлайн-режимі без помилок
- [x] Синхронізація працює стабільно при відновленні з'єднання
- [x] Міграції вперед і назад працюють коректно
- [ ] RLS-політики надійно захищають дані користувачів