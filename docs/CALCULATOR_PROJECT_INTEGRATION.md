# Інтеграція калькуляторів із системою проєктів

## Огляд

Ця документація описує реалізацію системи інтеграції калькуляторів із проєктами користувача в додатку "Розрахуй і В'яжи". Ця інтеграція дозволяє користувачам зберігати результати розрахунків в проєктах, організовувати їх та використовувати повторно.

## Структура даних

Система використовує WatermelonDB для зберігання даних проєктів та розрахунків. Основні моделі даних включають:

### Project (Проєкт)

```typescript
class Project extends Model {
  static table = 'projects';
  
  static associations: Associations = {
    calculations: { type: 'has_many', foreignKey: 'project_id' },
    notes: { type: 'has_many', foreignKey: 'project_id' },
    photos: { type: 'has_many', foreignKey: 'project_id' },
  };

  @text('name') name!: string;
  @text('description') description!: string;
  @text('status') status!: 'planned' | 'in_progress' | 'completed' | 'archived';
  @date('start_date') startDate!: Date;
  @date('end_date') endDate?: Date;
  @field('is_favorite') isFavorite!: boolean;
  @readonly @date('created_at') createdAt!: Date;
  @readonly @date('updated_at') updatedAt!: Date;

  @children('calculations') calculations: any;
  @children('notes') notes: any;
  @children('photos') photos: any;
}
```

### Calculation (Розрахунок)

```typescript
class Calculation extends Model {
  static table = 'calculations';
  
  static associations = {
    projects: { type: 'belongs_to', key: 'project_id' },
  };

  @text('calculator_type') calculatorType!: string;
  @text('calculator_title') calculatorTitle!: string;
  @json('input_values') inputValues!: Record<string, any>;
  @json('results') results!: Record<string, any>;
  @text('notes') notes?: string;
  @relation('projects', 'project_id') project!: any;
  @readonly @date('created_at') createdAt!: Date;
  @readonly @date('updated_at') updatedAt!: Date;
}
```

## Основні компоненти

### 1. Калькулятори з кнопкою "Зберегти до проєкту"

Кожен калькулятор містить кнопку "Зберегти до проєкту", яка з'являється після виконання розрахунку. Коли користувач натискає на цю кнопку, відкривається модальне вікно для вибору проєкту.

Приклад реалізації в `YarnCalculator.tsx`:

```tsx
{result && (
  <View style={styles.resultContainer}>
    <Text style={styles.resultTitle}>Результат розрахунку:</Text>
    <Text style={styles.resultText}>
      Необхідна кількість пряжі: {result.yarnNeeded.toFixed(2)} г
    </Text>
    <Text style={styles.resultText}>
      Кількість мотків: {result.ballsNeeded} шт.
    </Text>
    
    <Button 
      title="Зберегти до проєкту" 
      onPress={handleSaveToProject} 
      style={styles.saveButton}
      variant="primary"
    />
  </View>
)}
```

### 2. Модальне вікно вибору проєкту

Модальне вікно `SaveCalculationModal.tsx` дозволяє користувачу або створити новий проєкт, або вибрати існуючий для збереження результатів розрахунку. Модальне вікно містить:

- Радіокнопки для вибору між створенням нового проєкту та вибором існуючого
- Форму для створення нового проєкту з полями для назви та опису
- Список існуючих проєктів для вибору
- Кнопки "Скасувати" та "Зберегти"

### 3. Вкладка розрахунків у деталях проєкту

Компонент `ProjectCalculationsTab.tsx` відображає всі збережені в проєкті розрахунки. Для кожного розрахунку доступні наступні дії:

- Перегляд вхідних даних та результатів
- Редагування розрахунку (відкриває відповідний калькулятор з предзаповненими даними)
- Видалення розрахунку

Також є кнопка для додавання нового розрахунку, яка перенаправляє на список доступних калькуляторів.

### 4. Список калькуляторів

Компонент `CalculatorsList.tsx` відображає список всіх доступних калькуляторів, які можна використати для додавання нового розрахунку до проєкту. Кожен калькулятор представлений з іконкою, назвою та описом.

### 5. Вкладки в деталях проєкту

Деталі проєкту (компонент `ProjectDetails.tsx`) тепер містять вкладки для різних типів даних:

- Інформація - загальні відомості про проєкт
- Розрахунки - всі збережені розрахунки для проєкту
- Нотатки - поки не реалізовано, заплановано на майбутнє
- Фотографії - поки не реалізовано, заплановано на майбутнє

## Сервіс для роботи з проєктами

Сервіс `projectsService.ts` надає методи для роботи з проєктами та розрахунками:

- `getUserProjects()` - отримання всіх проєктів користувача
- `getProjectById(id)` - отримання проєкту за ID
- `createProject(projectData)` - створення нового проєкту
- `updateProject(id, projectData)` - оновлення існуючого проєкту
- `deleteProject(id)` - видалення проєкту
- `getProjectCalculations(projectId)` - отримання всіх розрахунків проєкту
- `addCalculationToProject(projectId, calculationData)` - додавання нового розрахунку до проєкту
- `updateCalculation(id, calculationData)` - оновлення існуючого розрахунку
- `deleteCalculation(id)` - видалення розрахунку

## Потоки взаємодії

### Збереження розрахунку до проєкту

1. Користувач відкриває калькулятор
2. Заповнює поля та натискає "Розрахувати"
3. Після відображення результатів, натискає "Зберегти до проєкту"
4. Відкривається модальне вікно, де користувач може:
   - Створити новий проєкт
   - Вибрати існуючий проєкт
5. Після збереження, користувач отримує повідомлення про успіх

### Перегляд та редагування розрахунків

1. Користувач відкриває деталі проєкту
2. Переходить на вкладку "Розрахунки"
3. Вибирає розрахунок і відкриває його деталі
4. Може натиснути "Редагувати", що відкриє відповідний калькулятор з предзаповненими даними
5. Після редагування та нового розрахунку, користувач може оновити існуючий розрахунок

## Плани на майбутнє

1. Реалізація редагування нотаток в проєкті
2. Додавання фотографій до проєкту
3. Додавання лічильника рядів у проєкт
4. Додавання можливості експорту розрахунків у PDF
5. Реалізація функціоналу рекомендацій по пряжі

## Висновки

Реалізована інтеграція калькуляторів із системою проєктів дозволяє користувачам зберігати та організовувати результати розрахунків для подальшого використання та редагування. Це значно підвищує зручність та функціональність додатку, роблячи його більш корисним для майстрів в'язання.