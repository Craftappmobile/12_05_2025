# Реалізація покращень NetworkIndicator та автоматизації міграцій

Цей документ описує реалізацію покращеного компонента NetworkIndicator та автоматизації клієнтських міграцій в проекті "Розрахуй і В'яжи".

## 1. Покращення компонента NetworkIndicator

### Опис змін

Компонент NetworkIndicator був удосконалений для відображення не тільки стану мережі, а й статусу синхронізації даних. Новий компонент тепер показує різні стани:

- **Онлайн**: Підключення до інтернету активне
- **Офлайн**: Немає підключення до інтернету
- **Синхронізація...**: Триває процес синхронізації з сервером
- **Синхронізовано**: Синхронізація успішно завершена
- **Помилка синхронізації**: Виникла помилка під час синхронізації
- **Є незбережені зміни**: Є локальні зміни, які не були синхронізовані з сервером

### Основні нові функції

1. **Відображення статусу синхронізації**: Компонент тепер відображає поточний статус синхронізації з використанням `SyncStage` з модуля `sync`.

2. **Індикатор активності**: Під час синхронізації відображається `ActivityIndicator` для візуального інформування користувача про триваючий процес.

3. **Ручна синхронізація**: При натисканні на компонент (якщо є підключення до інтернету) запускається ручна синхронізація.

4. **Візуальні стилі**: Додані нові стилі для різних станів (синій для синхронізації, оранжевий для помилки, фіолетовий для незбережених змін).

### Приклад використання

```jsx
<NetworkIndicator 
  customText={{
    online: 'Онлайн',
    offline: 'Офлайн',
    syncing: 'Синхронізація...',
    syncComplete: 'Все синхронізовано',
    syncError: 'Помилка'
  }}
  onSync={() => console.log('Запуск синхронізації')}
  hasUnsynced={true}
/>
```

## 2. Автоматизація клієнтських міграцій

### Опис реалізації

Реалізовано сервіс `MigrationService` у файлі `src/services/migrations/migrationService.ts`, який автоматизує процес міграцій бази даних WatermelonDB. Сервіс підтримує як міграції вперед, так і назад (відкат).

### Основні функції

1. **Автоматична перевірка необхідності міграції**: Метод `checkMigrationNeeded()` перевіряє, чи потрібна міграція, порівнюючи збережену версію схеми з поточною версією WatermelonDB.

2. **Автоматичне виконання міграцій**: Метод `autoMigrate()` автоматично визначає, чи потрібна міграція вперед чи назад, та виконує відповідні дії.

3. **Синхронізація після міграції**: Після успішної міграції автоматично запускається синхронізація з сервером, якщо є підключення до інтернету.

4. **Перевірка та виправлення невідповідностей**: Метод `checkAndFixSchemaInconsistencies()` перевіряє та виправляє невідповідності в схемі бази даних.

5. **Хук для ініціалізації**: Функція `useMigrationInit()` призначена для виклику при запуску додатку, щоб автоматично перевірити та виконати необхідні міграції.

### Приклад використання

```jsx
// У кореневому компоненті додатку (App.tsx)
import { useMigrationInit } from './src/services/migrations';
import { useState, useEffect } from 'react';

function App() {
  const [migrationResult, setMigrationResult] = useState(null);
  const [isLoading, setIsLoading] = useState(true);
  
  useEffect(() => {
    async function initApp() {
      try {
        // Виконуємо перевірку та міграцію при запуску
        const result = await useMigrationInit();
        setMigrationResult(result);
      } catch (error) {
        console.error('Помилка при ініціалізації додатку:', error);
      } finally {
        setIsLoading(false);
      }
    }
    
    initApp();
  }, []);
  
  if (isLoading) {
    return <LoadingScreen message="Перевірка та оновлення бази даних..." />;
  }
  
  return (
    // Нормальний рендеринг додатку
  );
}
```

## 3. SQL скрипти для Supabase

### Моніторинг Supabase

Створено набір SQL-запитів для моніторингу бази даних в Supabase, які можна знайти в файлі `docs/supabase-monitoring-queries.md`. Серед них:

1. **Моніторинг синхронізації** - запити для відстеження кількості записів, останніх змін, виявлення потенційних конфліктів.

2. **Моніторинг продуктивності** - запити для виявлення повільних запитів, аналізу розміру таблиць, відстеження активності користувачів.

3. **Налаштування тригерів для моніторингу** - скрипти для створення журналу змін та тригерів відстеження змін.

### Серверні міграції

Створено SQL-скрипти для управління міграціями на сервері в Supabase, які знаходяться в `docs/supabase-migrations.md`. Ці скрипти відповідають трьом версіям схеми:

1. **Версія 1**: Початкова схема з таблицями `projects`, `calculations` та `photos`.

2. **Версія 2**: Додавання таблиці `notes`.

3. **Версія 3**: Додавання таблиці `user_settings`.

Кожна міграція має скрипти як для міграції вгору (UP), так і для відкату (DOWN), а також транзакційну логіку та журналювання.

## Висновки

Реалізовані покращення значно покращують користувацький досвід та надійність додатку "Розрахуй і В'яжи":

1. **Покращений NetworkIndicator** надає користувачам чітку інформацію про стан мережі та синхронізації, що покращує прозорість і зрозумілість додатку.

2. **Автоматизація міграцій** спрощує процес оновлення схеми бази даних, зменшуючи ризик помилок і забезпечуючи надійну синхронізацію.

3. **SQL запити для моніторингу** дозволяють проактивно виявляти та вирішувати проблеми синхронізації та продуктивності.

4. **Серверні міграції** забезпечують збереження цілісності даних між клієнтською та серверною частинами додатку.