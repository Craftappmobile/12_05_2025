# Діагностика та усунення помилок

## Виправлені помилки

### 1. Помилка: `TypeError: sanitizer is not a function (it is undefined)`

#### Опис проблеми
Ця помилка виникала в файлі `SaveCalculationModal.tsx` при виклику функції `sanitizer` для обробки даних перед збереженням у базу даних WatermelonDB.

#### Рішення
Функція `sanitizer` була покращена та розширена для більш надійної обробки різних типів даних:

- Обробка `undefined`, `null`, дат, масивів, вкладених об'єктів
- Захист від циклічних посилань
- Уникнення функцій та символів при серіалізації

### 2. Помилка: `TypeError: Cannot read property 'displayName' of undefined`

#### Опис проблеми
Помилка виникала при навігації до екрану `ProjectDetails`. Проблема пов'язана з бібліотекою `react-native-safe-area-context` та властивістю `displayName` компонента.

#### Рішення
Були внесені наступні зміни:

1. Додано властивість `displayName` для компонента `ProjectDetails`.
2. Додана явна типізація параметрів маршруту для `ProjectDetails`.
3. Удосконалено компонент `ErrorBoundary` для кращої обробки помилок рендерингу.

### 3. Невідповідність між моделлю та схемою бази даних

#### Опис проблеми
В моделі `Calculation` поля `inputValues` та `results` були оголошені з декоратором `@json`, але в схемі бази даних вони визначені як `string`.

#### Рішення
Модель `Calculation` була модифікована:

1. Поля `inputValues` та `results` тепер зберігаються як рядки (`@text`) в полях `inputValuesText` та `resultsText`.
2. Додані геттери та сеттери для збереження сумісності з існуючим кодом.
3. Забезпечена автоматична серіалізація/десеріалізація JSON даних.

### 4. Проблеми з кодуванням українських символів

#### Опис проблеми
В ряді файлів українські символи були представлені в escape-послідовностях вигляду `u04XX` замість прямих кириличних символів.

#### Рішення
Створено скрипт `fix-encoding.js` для автоматичного виправлення кодування українських символів у всіх файлах проєкту.

## Додаткові покращення

### 1. Удосконалення навігаційного сервісу

Service `navigationService` був розширений новими функціями:

- `navigateToProjectDetails` - безпечний перехід до деталей проєкту
- `diagnoseNavigation` - діагностика стану навігації

### 2. Створення утиліт для діагностики

Створено новий модуль `src/utils/diagnostics.ts` для діагностики та виправлення найпоширеніших помилок у додатку, включаючи:

- Перевірку функції `sanitizer`
- Перевірку навігації
- Перевірку обробки помилок
- React-компонент `DiagnosticButton` для запуску діагностики з інтерфейсу

### 3. Удосконалений компонент ErrorBoundary

Компонент `ErrorBoundary` був удосконалений для кращого виявлення та обробки проблем, пов'язаних з рендерингом.

## Рекомендації для подальшого розвитку

### 1. Кодування та локалізація

- Використовуйте UTF-8 кодування для всіх файлів проєкту.
- Періодично запускайте скрипт `fix-encoding.js` для виявлення та виправлення проблем з кодуванням.
- Розгляньте можливість використання бібліотеки i18n для організації локалізації.

### 2. Робота з даними

- Завжди використовуйте функцію `sanitizer` перед збереженням даних в WatermelonDB.
- Забезпечте узгодженість між схемою бази даних та моделями (типи полів).
- Додайте валідацію даних перед збереженням.

### 3. Навігація

- Використовуйте `navigationService.navigateToProjectDetails` замість прямої навігації до `ProjectDetails`.
- Завжди перевіряйте наявність параметрів маршруту перед їх використанням.
- Використовуйте типізацію для параметрів маршруту.

### 4. Обробка помилок

- Обгортайте компоненти в `ErrorBoundary` для захисту від неочікуваних помилок рендерингу.
- Використовуйте модуль `diagnostics` для виявлення проблем у додатку.
- Додайте логування для критичних операцій (зберігання даних, навігація тощо).

---

## Як запустити діагностику

Для діагностики стану додатку ви можете використати новий компонент `DiagnosticButton` або викликати функцію `diagnostics.runAllTests()` з модуля `src/utils/diagnostics.ts`.

Приклад використання в компоненті:

```jsx
import { DiagnosticButton } from '../utils/diagnostics';

// У вашому компоненті
const YourComponent = () => {
  return (
    <View>
      {/* ... Ваш контент ... */}
      <DiagnosticButton label="Діагностика додатку" />
    </View>
  );
};
```

## Виправлення кодування українських символів

Для виправлення проблем з кодуванням українських символів у файлах проєкту запустіть:

```bash
node fix-encoding.js
```

Скрипт автоматично знайде та виправить кодування у всіх файлах проєкту.